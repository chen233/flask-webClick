<div class="row mb-3">
    <div class="col-md-6">
        <label for="licence_number" class="form-label">Queensland learners permit / driver licence number</label>
        <input type="text" class="form-control" id="licence_number" name="licence_number"
               value="{{ booking.licence_number if booking else '' }}" required>
    </div>
    <div class="col-md-6">
        <label for="contact_name" class="form-label">Contact name</label>
        <input type="text" class="form-control" id="contact_name" name="contact_name"
               value="{{ booking.contact_name if booking else '' }}" required>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <label for="contact_phone" class="form-label">Contact phone number</label>
        <input type="text" class="form-control" id="contact_phone" name="contact_phone"
               value="{{ booking.contact_phone if booking else '' }}" required>
    </div>
    <div class="col-md-6">
        <label for="test_type_id" class="form-label">Test type</label>
        <select class="form-select" id="test_type_id" name="test_type_id" required>
            {% for type in test_types %}
            <option value="{{ type.id }}"
                    {% if booking and booking.test_type_id == type.id %}selected{% endif %}>
                {{ type.name }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
    <label for="region_id" class="form-label">Region</label>
    <select class="form-select" id="region_id" name="region_id" required>
        <option value="">选择地区</option>
        {% for region in regions %}
        <option value="{{ region.id }}"
                {% if booking and booking.region_id == region.id %}selected{% endif %}>
            {{ region.name }}
        </option>
        {% endfor %}
    </select>
</div>

    <!-- 中心选择框初始状态设为禁用 -->
    <!-- Centre 下拉框（初始禁用，随 Region 变化动态加载） -->
<div class="col-md-6">
    <label for="centre_id" class="form-label">Centre</label>
    <select class="form-select" id="centre_id" name="centre_id" required disabled>
        <option value="">请先选择地区</option>
    </select>
</div>

</div>

<div class="row mb-3">
    <div class="col-md-6">
        <label for="available_time" class="form-label">Available booking time</label>
        <input type="datetime-local" class="form-control" id="available_time" name="available_time"
               value="{{ booking.available_time if booking else '' }}" required>
    </div>
    <div class="col-md-6">
        <label for="email" class="form-label">Email address</label>
        <input type="email" class="form-control" id="email" name="email"
               value="{{ booking.email if booking else '' }}" required>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <label for="card_number" class="form-label">Card number</label>
        <input type="text" class="form-control" id="card_number" name="card_number"
               value="{{ booking.card_number if booking else '' }}" required>
    </div>
    <div class="col-md-4">
        <label for="expiry_month" class="form-label">Expiry Month</label>
        <input type="text" class="form-control" id="expiry_month" name="expiry_month"
               placeholder="MM" maxlength="2"
               value="{{ booking.expiry_month if booking else '' }}" required>
    </div>
    <div class="col-md-4">
        <label for="cvn" class="form-label">CVN</label>
        <input type="text" class="form-control" id="cvn" name="cvn"
               value="{{ booking.cvn if booking else '' }}" required>
    </div>
</div>


<script>
// 确保页面完全加载后执行
$(document).ready(function() {
    // 加载中心的函数
    function loadCentres(regionId, selectedCentreId) {
        const $centre = $('#centre_id');
        $centre.html('<option value="">加载中...</option>').prop('disabled', true);

        if (regionId) {
            // 调用后端接口
            $.getJSON(`/get_centres/${regionId}`, function(data) {
                if (data.length > 0) {
                    $centre.empty().prop('disabled', false);
                    data.forEach(centre => {
                        const $option = $(`<option value="${centre.id}">${centre.name}</option>`);
                        if (selectedCentreId && centre.id == selectedCentreId) {
                            $option.prop('selected', true);
                        }
                        $centre.append($option);
                    });
                } else {
                    $centre.html('<option value="">该地区无中心，请先添加</option>');
                }
            }).fail(function() {
                $centre.html('<option value="">加载失败，请刷新页面</option>');
            });
        } else {
            $centre.html('<option value="">请先选择地区</option>');
        }
    }

    // 监听地区变化
    $('#region_id').on('change', function() {
        loadCentres($(this).val());
    });

    // 编辑时初始化
    {% if booking %}
        // 强制触发一次地区选择事件
        $('#region_id').val({{ booking.region_id }}).trigger('change');
    {% endif %}
});
</script>
