{% extends 'base.html' %}

{% block content %}
<!-- 下拉框数据管理 -->
<div class="card mb-4">
    <div class="card-header">
        <h5>下拉框数据管理</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- 测试类型管理 -->
            <div class="col-md-4 mb-3">
                <h6>测试类型</h6>
                <form method="POST" action="{{ url_for('add_test_type') }}" class="d-flex mb-2">
                    <input type="text" name="test_type" class="form-control me-2" placeholder="新增测试类型" required>
                    <button type="submit" class="btn btn-sm btn-primary">添加</button>
                </form>
                <ul class="list-group">
                    {% for type in test_types %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ type.name }}
                        <form method="POST" action="{{ url_for('delete_test_type', id=type.id) }}" onsubmit="return confirmDelete()">
                            <button type="submit" class="btn btn-sm btn-danger">删除</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- 地区管理 -->
            <div class="col-md-4 mb-3">
                <h6>地区</h6>
                <form method="POST" action="{{ url_for('add_region') }}" class="d-flex mb-2">
                    <input type="text" name="region" class="form-control me-2" placeholder="新增地区" required>
                    <button type="submit" class="btn btn-sm btn-primary">添加</button>
                </form>
                <ul class="list-group">
                    {% for region in regions %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ region.name }}
                        <form method="POST" action="{{ url_for('delete_region', id=region.id) }}" onsubmit="return confirmDelete()">
                            <button type="submit" class="btn btn-sm btn-danger">删除</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- 中心管理 -->
            <div class="col-md-4 mb-3">
                <h6>中心</h6>
                <form method="POST" action="{{ url_for('add_centre') }}" class="d-flex mb-2">
                    <input type="text" name="centre" class="form-control me-2" placeholder="新增中心" required>
                    <button type="submit" class="btn btn-sm btn-primary">添加</button>
                </form>
                <ul class="list-group">
                    {% for centre in centres %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ centre.name }}
                        <form method="POST" action="{{ url_for('delete_centre', id=centre.id) }}" onsubmit="return confirmDelete()">
                            <button type="submit" class="btn btn-sm btn-danger">删除</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 新增记录按钮 -->
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addModal">
    新增记录
</button>

<!-- 表格 -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Queensland learners permit / driver licence number</th>
                        <th>Contact name</th>
                        <th>Contact phone number</th>
                        <th>Test type</th>
                        <th>Region</th>
                        <th>Centre</th>
                        <th>Available booking time</th>
                        <th>Email address</th>
                        <th>Card number</th>
                        <th>Expiry date</th>
                        <th>data</th>
                        <th>CVN</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr>
                        <td>{{ booking.id }}</td>
                        <td>{{ booking.licence_number }}</td>
                        <td>{{ booking.contact_name }}</td>
                        <td>{{ booking.contact_phone }}</td>
                        <td>{{ booking.test_type_name }}</td>
                        <td>{{ booking.region_name }}</td>
                        <td>{{ booking.centre_name }}</td>
                        <td>{{ booking.available_time }}</td>
                        <td>{{ booking.email }}</td>
                        <td>{{ booking.card_number }}</td>
                        <td>{{ booking.expiry_date }}</td>
                        <td>{{ booking.data }}</td>
                        <td>{{ booking.cvn }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" 
                                    data-bs-target="#editModal{{ booking.id }}">编辑</button>
                            <form method="POST" action="{{ url_for('delete_booking', id=booking.id) }}" 
                                  onsubmit="return confirmDelete()" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger">删除</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 新增记录模态框 -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">新增记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('add_booking') }}">
                    {% include 'form_fields.html' %}
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 编辑记录模态框 -->
{% for booking in bookings %}
<div class="modal fade" id="editModal{{ booking.id }}" tabindex="-1" aria-labelledby="editModalLabel{{ booking.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel{{ booking.id }}">编辑记录 #{{ booking.id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('update_booking', id=booking.id) }}">
                    {% include 'form_fields.html' with context %}
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">更新</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- 表单字段模板 -->
{% macro form_fields() %}
<div class="row mb-3">
    <div class="col-md-6">
        <label for="licence_number" class="form-label">Queensland learners permit / driver licence number</label>
        <input type="text" class="form-control" id="licence_number" name="licence_number" 
               value="{{ booking.licence_number if booking else '' }}" required>
    </div>
    <div class="col-md-6">
        <label for="contact_name" class="form-label">Contact name</label>
        <input type="text" class="form-control" id="contact_name" name="contact_name" 
               value="{{ booking.contact_name if booking else '' }}" required>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <label for="contact_phone" class="form-label">Contact phone number</label>
        <input type="text" class="form-control" id="contact_phone" name="contact_phone" 
               value="{{ booking.contact_phone if booking else '' }}" required>
    </div>
    <div class="col-md-6">
        <label for="test_type_id" class="form-label">Test type</label>
        <select class="form-select" id="test_type_id" name="test_type_id" required>
            {% for type in test_types %}
            <option value="{{ type.id }}" 
                    {% if booking and booking.test_type_id == type.id %}selected{% endif %}>
                {{ type.name }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <label for="region_id" class="form-label">Region</label>
        <select class="form-select" id="region_id" name="region_id" required>
            {% for region in regions %}
            <option value="{{ region.id }}" 
                    {% if booking and booking.region_id == region.id %}selected{% endif %}>
                {{ region.name }}
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-6">
        <label for="centre_id" class="form-label">Centre</label>
        <select class="form-select" id="centre_id" name="centre_id" required>
            {% for centre in centres %}
            <option value="{{ centre.id }}" 
                    {% if booking and booking.centre_id == centre.id %}selected{% endif %}>
                {{ centre.name }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <label for="available_time" class="form-label">Available booking time</label>
        <input type="datetime-local" class="form-control" id="available_time" name="available_time" 
               value="{{ booking.available_time if booking else '' }}" required>
    </div>
    <div class="col-md-6">
        <label for="email" class="form-label">Email address</label>
        <input type="email" class="form-control" id="email" name="email" 
               value="{{ booking.email if booking else '' }}" required>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <label for="card_number" class="form-label">Card number</label>
        <input type="text" class="form-control" id="card_number" name="card_number" 
               value="{{ booking.card_number if booking else '' }}" required>
    </div>
    <div class="col-md-4">
        <label for="expiry_date" class="form-label">Expiry date</label>
        <input type="month" class="form-control" id="expiry_date" name="expiry_date" 
               value="{{ booking.expiry_date if booking else '' }}" required>
    </div>
    <div class="col-md-4">
        <label for="cvn" class="form-label">CVN</label>
        <input type="text" class="form-control" id="cvn" name="cvn" 
               value="{{ booking.cvn if booking else '' }}" required>
    </div>
</div>

<div class="mb-3">
    <label for="data" class="form-label">data</label>
    <textarea class="form-control" id="data" name="data" rows="3">{{ booking.data if booking else '' }}</textarea>
</div>
{% endmacro %}

{{ form_fields() }}
{% endblock %}